#include "display_SSD1306.h"

#include <stdlib.h>
#include <stdio.h>

#include "i2c.h"
#include "app_util_platform.h"
#include "app_error.h"

#define NRF_LOG_MODULE_NAME "DISP"

#include "nrf_log.h"
#include "nrf_log_ctrl.h"

// the memory buffer for the LCD

static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0xF0, 0xF0, 0x00, 
0x00, 0x00, 0x00, 0xC0, 0xE0, 0x70, 0x30, 0x30, 0x70, 0xE0, 
0xC0, 0x00, 0x00, 0x60, 0x60, 0x30, 0x30, 0xB0, 0xF0, 0xE0, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x20, 0x30, 0x30, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xC0, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 
0x00, 0x00, 0x80, 0x80, 0x80, 0xE0, 0xE0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x80, 0xE0, 0xF0, 0x30, 0x30, 0x70, 0xE0, 0xC0, 
0x00, 0x00, 0xE0, 0xE0, 0x30, 0x30, 0x30, 0xF0, 0xE0, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 
0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
0x00, 0x3F, 0x7F, 0xE0, 0xC0, 0xC0, 0xE0, 0x7F, 0x3F, 0x00, 
0x10, 0x70, 0xF0, 0xC3, 0xC3, 0xC7, 0x7F, 0x7C, 0x18, 0x00, 
0x00, 0x10, 0x7C, 0x7F, 0x7F, 0x7F, 0x7E, 0x18, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x60, 0x67, 
0xC7, 0xC3, 0xC3, 0x7F, 0x7E, 0x18, 0x00, 0x00, 0x00, 0x1F, 
0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x3F, 0x1F, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x1F, 0x7F, 0xF0, 0xC0, 0xC0, 0xE0, 0x7F, 0x3F, 0x00, 0x80, 
0xC0, 0xE0, 0xF0, 0xF8, 0xDE, 0xCF, 0xC3, 0xC0, 0x00, 0x00, 
0x80, 0x58, 0x3C, 0x7E, 0x3F, 0x1F, 0x0F, 0x07, 0x07, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x60, 0x90, 0x90, 0x90, 0x60, 0x00, 
0x00, 0x40, 0x00, 0xC0, 0x30, 0x10, 0x10, 0x30, 0xC0, 0x00, 
0x80, 0xF0, 0x90, 0x90, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0xF0, 0x00, 0x00, 
0x00, 0xE0, 0x10, 0x10, 0x10, 0xE0, 0x00, 0x00, 0x40, 0x00, 
0x40, 0x20, 0x10, 0x10, 0xB0, 0x40, 0x00, 0x60, 0x10, 0x10, 
0x30, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x60, 0x90, 0x90, 0xF0, 0x60, 0x00, 0x00, 0x40, 
0x00, 0xE0, 0x30, 0x10, 0x10, 0x60, 0x80, 0x00, 0xC0, 0xF0, 
0x90, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x07, 0x08, 0x08, 0x08, 0x07, 0x00, 0x00, 0x08, 
0x00, 0x03, 0x0C, 0x08, 0x08, 0x0C, 0x03, 0x00, 0x0C, 0x08, 
0x08, 0x0C, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x07, 
0x08, 0x08, 0x08, 0x07, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 
0x0C, 0x0B, 0x09, 0x08, 0x00, 0x06, 0x08, 0x08, 0x0C, 0x07, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x05, 0x08, 0x08, 0x08, 0x07, 0x00, 0x00, 0x08, 0x00, 0x07, 
0x0C, 0x08, 0x08, 0x06, 0x01, 0x04, 0x0C, 0x08, 0x08, 0x0D, 
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00
};

static volatile uint8_t i2c_tx_flag;

void display_init(void) {
    NRF_LOG_INFO("Display init.\r\n");
    
    // I2C Init
    i2c_tx_set_flag(&i2c_tx_flag);                  // Initialize I2C
    i2c_tx_flag = 0;
    i2c_init();
    
    // Init sequence
    ssd1306_command(SSD1306_DISPLAYOFF);            // 0xAE
    ssd1306_command(SSD1306_SETDISPLAYCLOCKDIV);    // 0xD5
    ssd1306_command(0x80);                          // the suggested ratio 0x80
        
    ssd1306_command(SSD1306_SETMULTIPLEX);          // 0xA8
    ssd1306_command(SSD1306_LCDHEIGHT - 1); 
        
    ssd1306_command(SSD1306_SETDISPLAYOFFSET);      // 0xD3
    ssd1306_command(0x0);                           // no offset
    ssd1306_command(SSD1306_SETSTARTLINE | 0x0);    // line #0
    ssd1306_command(SSD1306_CHARGEPUMP);            // 0x8D
    ssd1306_command(0x14);  
    ssd1306_command(SSD1306_MEMORYMODE);            // 0x20
    ssd1306_command(0x00);                          // 0x0 act like ks0108
    ssd1306_command(SSD1306_SEGREMAP | 0x1);    
    ssd1306_command(SSD1306_COMSCANDEC);    
        
    ssd1306_command(SSD1306_SETCOMPINS);            // 0xDA
    ssd1306_command(0x02);  
    ssd1306_command(SSD1306_SETCONTRAST);           // 0x81
    ssd1306_command(0x8F);  
        
    ssd1306_command(SSD1306_SETPRECHARGE);          // 0xd9
    ssd1306_command(0xF1);  
    ssd1306_command(SSD1306_SETVCOMDETECT);         // 0xDB
    ssd1306_command(0x40);  
        
    ssd1306_command(SSD1306_DISPLAYALLON_RESUME);   // 0xA4
    ssd1306_command(SSD1306_NORMALDISPLAY);         // 0xA6
    
    ssd1306_command(SSD1306_DEACTIVATE_SCROLL);
    
    ssd1306_command(SSD1306_DISPLAYON);
    
    NRF_LOG_INFO("Init done.\r\n");
    NRF_LOG_FLUSH();
}

void ssd1306_command(uint8_t command) {
    i2c_begin_transmission(SSD1306_I2C_ADDRESS);  // Begin I2C communication
    i2c_tx_flag = 0;                              // Reset flag
    i2c_write(0x80);                              // Set OLED command mode
    while(!i2c_tx_flag){};                        // Wait...
    i2c_tx_flag = 0;                              // Reset flag
    i2c_write(command);                           // Send command
    while(!i2c_tx_flag){};                        // Wait...
    i2c_end_transmission();                       // End I2C communication
}

void ssd1306_data(uint8_t data) {
    i2c_begin_transmission(SSD1306_I2C_ADDRESS);  // Begin I2C communication
    i2c_tx_flag = 0;                              // Reset flag
    i2c_write(0x40);                              // Set OLED command mode
    while(!i2c_tx_flag){};                        // Wait...
    i2c_tx_flag = 0;                              // Reset flag
    i2c_write(data);                              // Send data
    while(!i2c_tx_flag){};                        // Wait...
    i2c_end_transmission();                       // End I2C communication
}

void display_show(void) {
    ssd1306_command(SSD1306_COLUMNADDR);
    ssd1306_command(0);   // Column start address (0 = reset)
    ssd1306_command(SSD1306_LCDWIDTH-1); // Column end address (127 = reset)
    
    ssd1306_command(SSD1306_PAGEADDR);
    ssd1306_command(0); // Page start address (0 = reset)
    ssd1306_command(3); // Page end address
    
    for (uint32_t i=0; i<(SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8); i++) {
        ssd1306_data(buffer[i]);
    }
}

void display_clear(void) {
    for (uint32_t i=0; i<(SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8); i++) {
        buffer[i] = 0;
    }
}

void display_draw_pixel(int16_t x, int16_t y, uint16_t color) {
    if ((x < 0) || (x >= SSD1306_LCDWIDTH) || (y < 0) || (y >= SSD1306_LCDHEIGHT))
        return;

    switch (color) {
        case WHITE:   buffer[x+ (y/8)*SSD1306_LCDWIDTH] |=  (1 << (y&7)); break;
        case BLACK:   buffer[x+ (y/8)*SSD1306_LCDWIDTH] &= ~(1 << (y&7)); break;
        case INVERSE: buffer[x+ (y/8)*SSD1306_LCDWIDTH] ^=  (1 << (y&7)); break;
    }
}
